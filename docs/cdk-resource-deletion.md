# CDKリソース削除時の動作

このドキュメントでは、`cdk destroy`コマンドを実行した際に削除されるリソースと削除されないリソースについて説明します。

## 削除されるリソース

以下のリソースは`cdk destroy`コマンドによって自動的に削除されます：

### ネットワーク関連

- **VPC** - CDKで作成されたVPC（デフォルト: 192.168.0.0/16）
- **サブネット** - 2つのパブリックサブネット
  - Subnet1（デフォルト: 192.168.0.0/20）
  - Subnet2（デフォルト: 192.168.16.0/20）
- **インターネットゲートウェイ** - VPCに関連付けられたIGW
- **ルートテーブル** - サブネットに関連付けられたルートテーブル

### セキュリティ関連

- **セキュリティグループ**
  - ALB用セキュリティグループ
  - EC2インスタンス用セキュリティグループ
- **セキュリティグループルール** - 上記セキュリティグループに設定されたすべてのルール

### コンピューティング関連

- **EC2インスタンス** - t3.largeインスタンス
- **EBSボリューム** - EC2インスタンスにアタッチされた20GBの暗号化ボリューム
- **Elastic IP** - EC2インスタンスに関連付けられたパブリックIP

### ロードバランサー関連

- **Application Load Balancer (ALB)**
- **ターゲットグループ** - EC2インスタンスを含むターゲットグループ
- **リスナー** - HTTP（ポート80）およびHTTPS（ポート443）リスナー
- **リスナールール** - ALBに設定されたルーティングルール

### IAM関連

- **IAMロール** - EC2インスタンス用のロール（DifyWebServerInstanceRole）
- **インスタンスプロファイル** - EC2インスタンスに関連付けられたプロファイル
- **IAMポリシー** - CDKによって作成されたカスタムポリシー（存在する場合）

### CloudFormation関連

- **CloudFormationスタック** - DifyStack-dev/DifyStack-prod
- **スタック出力** - ALBEndpoint、InstancePublicIP、InstanceIdなどの出力値

## 削除されないリソース（オーファンリソース）

以下のリソースは`cdk destroy`コマンドを実行しても削除されません：

### 事前に作成が必要なリソース

- **EC2キーペア**
  - パラメータ`KeyName`で指定（デフォルト: dify-key）
  - CDKの管理外のため手動で削除が必要

### 外部参照リソース

- **ACM証明書**
  - `certificateArn`で指定される証明書
  - CDKでは参照のみで管理対象外

### DNS関連

- **Route 53レコード**
  - カスタムドメイン用に手動で作成したAレコード
  - ホストゾーン自体も手動管理の場合は残存

### ログ・監視関連

- **CloudWatchログ**
  - EC2インスタンス内のDockerコンテナが生成したログ
  - システムログ
  - アプリケーションログ

### バックアップ関連

- **EBSスナップショット**
  - 手動または自動で作成されたボリュームのスナップショット
  - AWS Backupで作成されたバックアップ

### Docker関連（EC2インスタンス内）

- **Dockerイメージ**
  - EC2インスタンス削除前にpullされたイメージのキャッシュ（ECRなどに保存されている場合）
- **Dockerボリューム**
  - 永続化データ（ただしEC2削除時に一緒に削除される）

## 完全なクリーンアップ手順

環境を完全にクリーンアップするには以下の手順を実行してください：

1. **CDKスタックの削除**

   ```bash
   export AWS_ACCESS_KEY_ID=<your-access-key-id>
   export AWS_SECRET_ACCESS_KEY=<your-secret-access-key>
   export AWS_DEFAULT_REGION=ap-northeast-1

   cdk destroy -c environment=dev
   # または
   cdk destroy -c environment=prod
   ```

2. **EC2キーペアの削除**（AWS Console または CLI）

   ```bash
   aws ec2 delete-key-pair --key-name dify-key
   ```

3. **Route 53レコードの削除**（カスタムドメインを使用している場合）

   - AWS Consoleから該当するAレコードを削除

4. **CloudWatchログの削除**（必要に応じて）

   ```bash
   aws logs delete-log-group --log-group-name /aws/ec2/dify
   ```

5. **EBSスナップショットの削除**（存在する場合）
   - AWS Consoleから不要なスナップショットを確認して削除

## 注意事項

- **データの永続性**: EC2インスタンス内のDifyアプリケーションデータは、インスタンス削除時に失われます。重要なデータは事前にバックアップしてください。

- **コスト**: 削除されないリソース（特にEBSスナップショット、CloudWatchログ）は継続的にコストが発生する可能性があります。

- **依存関係**: 他のリソースから参照されているリソース（ACM証明書など）は、参照元のリソースが存在する限り削除できません。

- **削除の順序**: CDKは依存関係を考慮して適切な順序でリソースを削除しますが、手動で作成したリソースとの依存関係は管理されません。

## 削除前のチェックリスト

- [ ] Difyアプリケーションのデータをバックアップした
- [ ] カスタム設定や環境変数を記録した
- [ ] 必要なCloudWatchログをエクスポートした
- [ ] Route 53のDNS設定を確認した
- [ ] 削除対象の環境（dev/prod）を確認した
